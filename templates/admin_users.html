<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Users</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
/* ========================
   Admin - Users Page
   ======================== */
.admin-container {
  max-width: 1400px;
  margin: 40px auto;
  background: var(--bg-card);
  padding: 30px;
  border-radius: 15px;
  border: 1px solid var(--border-color);
  box-shadow: 0 8px 20px var(--shadow-color);
}

/* Top bar (back + add user) */
.admin-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
}

.back-btn {
  text-decoration: none;
  font-weight: 600;
  font-size: 1rem;
  color: var(--purple);
  transition: color 0.3s, transform 0.2s;
}
.back-btn:hover {
  color: var(--green);
  transform: translateX(-3px);
}

/* Title */
.admin-container h2 {
  text-align: center;
  font-size: 2rem;
  font-weight: 800;
  margin-bottom: 20px;
  background: var(--accent-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Flash messages */
.flash-dialog {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.flash-dialog-content {
  background: #fff;
  padding: 25px 40px;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  text-align: center;
  max-width: 500px;
  font-size: 1.1rem;
  color: #333;
}

.flash-dialog-content p {
  margin-bottom: 15px;
}

.flash-dialog-content button {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  background: var(--green);
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s ease;
}

.flash-dialog-content button:hover {
  background: #1f5e37;
}

/* Search + action buttons */
.admin-actions {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 15px;
  margin-bottom: 20px;
  margin-top: 20px;
}

.admin-actions input[type="text"] {
  padding: 8px 12px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  min-width: 250px;
}
.admin-actions button {
  background: var(--accent-primary);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
}
.admin-actions button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px var(--shadow-color);
}

/* Table */
.admin-container table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
}
.admin-container th {
  background: var(--accent-primary);
  color: #fff;
  text-align: left;
  padding: 12px;
  font-size: 1rem;
}
.admin-container td {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border-color);
}
.admin-container tr:hover td {
  background: var(--card-hover);
}

/* Buttons */
.btn-edit,
.btn-view,
.btn-delete {
  padding: 6px 12px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
}
.btn-edit {
  background: var(--purple);
  color: #fff;
}
.btn-edit:hover { background: #45227d; }
.btn-view {
  background: var(--green);
  color: #fff;
}
.btn-view:hover { background: #1f5e37; }
.btn-delete {
  background: var(--yellow);
  color: #fff;
}
.btn-delete:hover { background: #b58900; }

    </style>
</head>
<body>
    <div class="admin-container">
        
        <div class="admin-top">
            <a href="/admin/dashboard" class="back-btn">Back to Dashboard</a>
            <a href="/admin/users/add" class="back-btn">‚ûï Add Users</a>
        </div>

        <h2>Registered Users</h2>

        <!-- üîç Search + Actions -->
        <div class="admin-actions">
            <form method="get" action="/admin/users/search" style="display: flex; gap: 10px; align-items: center;">
  <input type="text" name="query" placeholder="Search by username..." required style="height: 40px; padding: 8px 8px; border-radius: 6px; border: 1px solid var(--border-color);margin-top: -4px;">
  <button type="submit" style="height: 40px; padding: 0 16px; border: none; border-radius: 6px; background: var(--accent-primary); color: white; font-weight: 600; cursor: pointer;">Search</button>
</form>

            <form method="get" action="/admin/users">
                <button type="submit" class="btn-view">View All Users</button>
            </form>

            <form method="post" action="/admin/users/delete_all">
                <button type="submit" class="btn-delete">Delete All Users</button>
            </form>
        </div>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="flash-dialog" id="flashDialog">
      <div class="flash-dialog-content">
        {% for message in messages %}
          <p>{{ message }}</p>
        {% endfor %}
        <button onclick="closeFlashDialog()">OK</button>
      </div>
    </div>
    <script>
      function closeFlashDialog() {
        document.getElementById("flashDialog").style.display = "none";
      }
    </script>
  {% endif %}
{% endwith %}


        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>Smartcard No.</th>
                    <th>Balance</th>
                    <th>Status / Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <form method="post" action="/admin/users/edit/{{ user.id }}">
                        <td>{{ user.id }}</td>
                        <td><input type="text" name="username" value="{{ user.username }}" required></td>
                        <td><input type="text" name="phone" value="{{ user.phone }}" required></td>
                        <td><input type="text" name="email" value="{{ user.email }}" required></td>
                        <td><input type="text" name="smartcard_number" value="{{ user.smartcard_number }}" readonly></td>
                        <td><p id="balance-{{ user.id }}">{{ user.balance }}</p></td>
                        <td style="display:flex; flex-wrap:wrap; gap:6px;">
                            <select name="status" required>
                                <option value="Processing" {{ 'selected' if user.status == 'Processing' else '' }}>Processing</option>
                                <option value="Pending" {{ 'selected' if user.status == 'Pending' else '' }}>Pending</option>
                                <option value="Issued" {{ 'selected' if user.status == 'Issued' else '' }}>Issued</option>
                            </select>
                            <button type="submit" class="btn-edit">‚úèÔ∏è Edit</button>
                        </form>
                        <form method="post" action="/admin/users/delete/{{ user.id }}">
                            <button type="submit" class="btn-delete">üóëÔ∏è Delete</button>
                        </form>
                        <button class="btn-view" onclick="rechargeUser({{ user.id }})">üí∞ Recharge</button>
                        </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

<script>
function rechargeUser(userId) {
    const amount = prompt("Enter recharge amount:");
    if (!amount || isNaN(amount) || amount <= 0) {
        alert("Invalid amount.");
        return;
    }
    fetch(`/admin/users/recharge/${userId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount: parseFloat(amount) })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`balance-${userId}`).textContent = data.new_balance;
            alert("‚úÖ Recharge successful!");
        } else {
            alert("‚ùå Recharge failed.");
        }
    });
}
</script>
</body>
</html>
